<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="style.css">
  <meta charset="UTF-8">
  <title>案件詳細ページ</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>

  <script>
    // EmailJS 初期化
    emailjs.init("YOUR_EMAILJS_PUBLIC_KEY");

    // Firebase 初期化（修正済みの storageBucket）
    const firebaseConfig = {
      apiKey: "AIzaSyDPLwpz4GcsNrmn6HNKLPmQWokZgKT4Cis",
      authDomain: "oata-8c05b.firebaseapp.com",
      projectId: "oata-8c05b",
      storageBucket: "oata-8c05b.firebasestorage.app",
      messagingSenderId: "949261471175",
      appId: "1:949261471175:web:28482b939262d8e93f1de2",
      measurementId: "G-02LMR8FTNX"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const storage = firebase.storage();

    const params = new URLSearchParams(window.location.search);
    const companyId = params.get("company");
    const threadId = params.get("thread");

    if (!companyId || !threadId) {
      alert("無効なURLです。ダッシュボードに戻ります。");
      window.location.href = "dashboard.html";
    }

    let currentData = {};

    function uploadImage() {
      const fileInput = document.getElementById("imageInput");
      const file = fileInput.files[0];

      if (!file) {
        alert("画像を選択してください。");
        return;
      }

      const storageRef = storage.ref(`uploads/${companyId}/${threadId}/${file.name}`);
      storageRef.put(file)
        .then(snapshot => snapshot.ref.getDownloadURL())
        .then(downloadURL => {
          console.log("アップロード成功:", downloadURL);
          document.getElementById("uploadedImage").innerHTML = `<img src="${downloadURL}" style="max-width: 100%; height: auto;">`;

          return db.collection("companies").doc(companyId).collection("threads").doc(threadId)
            .update({ imageURL: downloadURL });
        })
        .then(() => {
          alert("画像がアップロードされました！");
        })
        .catch(error => {
          console.error("画像アップロードエラー:", error);
          alert("画像のアップロードに失敗しました。");
        });
    }

    function loadCaseDetails() {
      db.collection("companies").doc(companyId).collection("threads").doc(threadId)
        .get()
        .then(doc => {
          if (doc.exists) {
            currentData = doc.data();
            renderCaseDetails();
          }
        })
        .catch(error => {
          console.error("案件詳細の読み込みエラー:", error);
        });
    }

    function renderCaseDetails() {
      const detailsDiv = document.getElementById("caseDetails");
      detailsDiv.innerHTML = `
        <h2>${currentData.caseTitle}</h2>
        <p>出発地: ${currentData.departure}</p>
        <p>出発日: ${currentData.departureDate || "-"}</p>
        <p>帰着地: ${currentData.arrival}</p>
        <p>帰着日: ${currentData.arrivalDate || "-"}</p>
        <p>マル契種類: ${currentData.contractType}</p>
        <p>金額（予定）: ${currentData.estimatedPrice || "-"}</p>
        <p>金額（確定）: ${currentData.confirmedPrice || "-"}</p>
        <p>備考: ${currentData.remarks || "-"}</p>
        ${ currentData.imageURL ? `<img src="${currentData.imageURL}" style="max-width:100%; height:auto; margin-top:10px;">` : "" }
        <p>作成日時: ${currentData.last_updated?.toDate().toLocaleString()}</p>
      `;
    }

    function submitComment() {
      const newComment = document.getElementById("newComment").value;
      if (!newComment) {
        alert("コメントを入力してください。");
        return;
      }
      const commentData = {
        name: "販売店担当者",
        text: newComment,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      db.collection("companies").doc(companyId).collection("threads").doc(threadId).collection("comments")
        .add(commentData)
        .then(() => {
          document.getElementById("newComment").value = "";
          alert("コメントを投稿しました！");
        })
        .catch(error => {
          console.error("コメント投稿エラー:", error);
        });
    }

    function goToDashboard() {
      window.location.href = `dashboard.html?company=${companyId}`;
    }

    window.onload = () => {
      loadCaseDetails();
    };
  </script>
</head>

<body>
  <button onclick="goToDashboard()" style="margin-bottom: 20px;">販売店ダッシュボード</button>

  <h1>案件詳細ページ</h1>
  <div id="caseDetailsContainer">
    <div id="caseDetails"></div>
    <button id="editButton" onclick="toggleEditMode()">編集</button>
  </div>

  <!-- 画像アップロード -->
  <h3>画像アップロード</h3>
  <input type="file" id="imageInput" accept="image/*"><br>
  <button onclick="uploadImage()">画像をアップロード</button>
  <div id="uploadedImage"></div>

  <h3>コメント一覧</h3>
  <div id="commentsList"></div>
  
  <h3>新しいコメントを投稿</h3>
  <textarea id="newComment" placeholder="コメントを入力"></textarea><br>
  <button onclick="submitComment()">コメントを投稿</button>

</body>
</html>