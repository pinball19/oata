<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="style.css">
  <meta charset="UTF-8">
  <title>案件詳細ページ</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- 画像アップロードに必要なFirebase Storageを追加 -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <!-- EmailJS -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <!-- ★ スピナー用の簡易CSS（お好みで調整可能） -->
  <style>
    /* スピナー本体 */
    #spinner {
      display: none;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px;
    }
    @keyframes spin {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* テーブルの見た目はお好みで調整 */
    table {
      border-collapse: collapse;
      margin-top: 1em;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5em;
      text-align: center;
    }
    th {
      background: #f9f9f9;
    }
  </style>

  <script>
    // EmailJS 初期化
    emailjs.init("xFGCcZ9228W3baa9y");

    // Firebase 初期化
const firebaseConfig = {
  apiKey: "AIzaSyDPLwpz4GcsNrmn6HNKLPmQWokZgKT4Cis",
  authDomain: "oata-8c05b.firebaseapp.com",
  projectId: "oata-8c05b",
  storageBucket: "oata-8c05b.firebasestorage.app",
  messagingSenderId: "949261471175",
  appId: "1:949261471175:web:28482b939262d8e93f1de2",
  measurementId: "G-02LMR8FTNX"
};
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>
  <!-- 販売店ダッシュボードへ戻るボタン -->
  <button onclick="goToDashboard()" style="margin-bottom: 20px;">販売店ダッシュボード</button>

  <h1>案件詳細ページ</h1>
  <!-- ★ スピナーを画面上に配置 -->
  <div id="spinner"></div>

  <div id="caseDetailsContainer">
    <div id="caseDetails"></div>
    <button id="editButton" onclick="toggleEditMode()">編集</button>
  </div>
  
  <h3>コメント一覧</h3>
  <div id="commentsList"></div>
  
  <h3>新しいコメントを投稿</h3>
  <textarea id="newComment" placeholder="コメントを入力"></textarea><br>
  <button onclick="submitComment()">コメントを投稿</button>

  <script>
    const db = firebase.firestore();
    const storage = firebase.storage();
    const params = new URLSearchParams(window.location.search);
    const companyId = params.get("company");
    const threadId = params.get("thread");
    // role パラメータを取得（デフォルトは販売店）
    const role = params.get("role") || "store";

    if (!companyId || !threadId) {
      alert("無効なURLです。ダッシュボードに戻ります。");
      window.location.href = "dashboard.html";
    }

    let currentData = {};
    let editing = false;

    // 案件情報を表示
    function loadCaseDetails() {
      db.collection("companies").doc(companyId).collection("threads").doc(threadId)
        .get()
        .then(doc => {
          if (doc.exists) {
            currentData = doc.data();
            renderCaseDetails();
          }
        })
        .catch(error => {
          console.error("Error loading case details:", error);
        });
    }

    // 表示用（通常モード）
    function renderCaseDetails() {
      const detailsDiv = document.getElementById("caseDetails");

      let html = `
        <h2>団体名: ${currentData.groupName || "-"}</h2>
        <p>団体名ふりがな: ${currentData.groupNameFurigana || "-"}</p>
        <p>団体種別: ${currentData.groupType || "-"}</p>
        <p>出発日: ${currentData.departureDate || "-"}</p>
        <p>帰着日: ${currentData.arrivalDate || "-"}</p>
      `;

      html += `
      <table>
        <thead>
          <tr>
            <th></th>
            <th>列車名</th>
            <th>発地</th>
            <th>着地</th>
            <th>大人</th>
            <th>小児</th>
            <th>添乗員</th>
            <th>座席</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th>第1希望</th>
            <td>${currentData.trainName || "-"}</td>
            <td>${currentData.departure || "-"}</td>
            <td>${currentData.arrival || "-"}</td>
            <td>${currentData.numberOfAdults || "-"}</td>
            <td>${currentData.numberOfChildren || "-"}</td>
            <td>${currentData.numberOfAttendants || "-"}</td>
            <td>${currentData.seatType || "-"}</td>
          </tr>
          <tr>
            <th>第2希望</th>
            <td>${currentData.secondTrainName || "-"}</td>
            <td>${currentData.secondDeparture || "-"}</td>
            <td>${currentData.secondArrival || "-"}</td>
            <td>${currentData.secondNumberOfAdults || "-"}</td>
            <td>${currentData.secondNumberOfChildren || "-"}</td>
            <td>${currentData.secondNumberOfAttendants || "-"}</td>
            <td>${currentData.secondSeatType || "-"}</td>
          </tr>
          <tr>
            <th>第3希望</th>
            <td>${currentData.thirdTrainName || "-"}</td>
            <td>${currentData.thirdDeparture || "-"}</td>
            <td>${currentData.thirdArrival || "-"}</td>
            <td>${currentData.thirdNumberOfAdults || "-"}</td>
            <td>${currentData.thirdNumberOfChildren || "-"}</td>
            <td>${currentData.thirdNumberOfAttendants || "-"}</td>
            <td>${currentData.thirdSeatType || "-"}</td>
          </tr>
        </tbody>
      </table>
      `;

      html += `
        <p>最終更新: ${
          currentData.last_updated
            ? currentData.last_updated.toDate().toLocaleString()
            : "-"
        }</p>
      `;

      if (currentData.imageUrl) {
        html += `
          <div>
            <p>添付画像:</p>
            <img src="${currentData.imageUrl}" alt="添付画像" style="max-width: 200px; max-height: 200px;">
          </div>
        `;
      }

      detailsDiv.innerHTML = html;
    }

    // 編集モードの切り替え
    function toggleEditMode() {
      const detailsDiv = document.getElementById("caseDetails");
      if (!editing) {
        detailsDiv.innerHTML = `
          <h2>団体名: <input type="text" id="edit_groupName" value="${currentData.groupName || ''}"></h2>
          <p>団体名ふりがな: <input type="text" id="edit_groupNameFurigana" value="${currentData.groupNameFurigana || ''}"></p>
          <p>団体種別: <input type="text" id="edit_groupType" value="${currentData.groupType || ''}"></p>
          <p>出発日: <input type="date" id="edit_departureDate" value="${currentData.departureDate || ''}"></p>
          <p>帰着日: <input type="date" id="edit_arrivalDate" value="${currentData.arrivalDate || ''}"></p>
          <table>
            <thead>
              <tr>
                <th></th>
                <th>列車名</th>
                <th>発地</th>
                <th>着地</th>
                <th>大人</th>
                <th>小児</th>
                <th>添乗員</th>
                <th>座席</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th>第1希望</th>
                <td><input type="text" id="edit_trainName" value="${currentData.trainName || ''}"></td>
                <td><input type="text" id="edit_departure" value="${currentData.departure || ''}"></td>
                <td><input type="text" id="edit_arrival" value="${currentData.arrival || ''}"></td>
                <td><input type="number" id="edit_numberOfAdults" value="${currentData.numberOfAdults || ''}"></td>
                <td><input type="number" id="edit_numberOfChildren" value="${currentData.numberOfChildren || ''}"></td>
                <td><input type="number" id="edit_numberOfAttendants" value="${currentData.numberOfAttendants || ''}"></td>
                <td><input type="text" id="edit_seatType" value="${currentData.seatType || ''}"></td>
              </tr>
              <tr>
                <th>第2希望</th>
                <td><input type="text" id="edit_secondTrainName" value="${currentData.secondTrainName || ''}"></td>
                <td><input type="text" id="edit_secondDeparture" value="${currentData.secondDeparture || ''}"></td>
                <td><input type="text" id="edit_secondArrival" value="${currentData.secondArrival || ''}"></td>
                <td><input type="number" id="edit_secondNumberOfAdults" value="${currentData.secondNumberOfAdults || ''}"></td>
                <td><input type="number" id="edit_secondNumberOfChildren" value="${currentData.secondNumberOfChildren || ''}"></td>
                <td><input type="number" id="edit_secondNumberOfAttendants" value="${currentData.secondNumberOfAttendants || ''}"></td>
                <td><input type="text" id="edit_secondSeatType" value="${currentData.secondSeatType || ''}"></td>
              </tr>
              <tr>
                <th>第3希望</th>
                <td><input type="text" id="edit_thirdTrainName" value="${currentData.thirdTrainName || ''}"></td>
                <td><input type="text" id="edit_thirdDeparture" value="${currentData.thirdDeparture || ''}"></td>
                <td><input type="text" id="edit_thirdArrival" value="${currentData.thirdArrival || ''}"></td>
                <td><input type="number" id="edit_thirdNumberOfAdults" value="${currentData.thirdNumberOfAdults || ''}"></td>
                <td><input type="number" id="edit_thirdNumberOfChildren" value="${currentData.thirdNumberOfChildren || ''}"></td>
                <td><input type="number" id="edit_thirdNumberOfAttendants" value="${currentData.thirdNumberOfAttendants || ''}"></td>
                <td><input type="text" id="edit_thirdSeatType" value="${currentData.thirdSeatType || ''}"></td>
              </tr>
            </tbody>
          </table>
          <p>添付画像（1枚のみ）: <input type="file" id="imageUpload" accept="image/*"></p>
          <button onclick="saveEdits()">保存</button>
          <button onclick="toggleEditMode()">キャンセル</button>
        `;
        editing = true;
      } else {
        renderCaseDetails();
        editing = false;
      }
    }

    function saveEdits() {
      document.getElementById("spinner").style.display = "block";
      const newGroupName = document.getElementById("edit_groupName").value.trim();
      const newGroupNameFurigana = document.getElementById("edit_groupNameFurigana").value.trim();
      const newGroupType = document.getElementById("edit_groupType").value.trim();
      const newDepartureDate = document.getElementById("edit_departureDate").value;
      const newArrivalDate = document.getElementById("edit_arrivalDate").value;
      const newTrainName = document.getElementById("edit_trainName").value.trim();
      const newDeparture = document.getElementById("edit_departure").value.trim();
      const newArrival = document.getElementById("edit_arrival").value.trim();
      const newNumberOfAdults = document.getElementById("edit_numberOfAdults").value.trim();
      const newNumberOfChildren = document.getElementById("edit_numberOfChildren").value.trim();
      const newNumberOfAttendants = document.getElementById("edit_numberOfAttendants").value.trim();
      const newSeatType = document.getElementById("edit_seatType").value.trim();
      const newSecondTrainName = document.getElementById("edit_secondTrainName").value.trim();
      const newSecondDeparture = document.getElementById("edit_secondDeparture").value.trim();
      const newSecondArrival = document.getElementById("edit_secondArrival").value.trim();
      const newSecondNumberOfAdults = document.getElementById("edit_secondNumberOfAdults").value.trim();
      const newSecondNumberOfChildren = document.getElementById("edit_secondNumberOfChildren").value.trim();
      const newSecondNumberOfAttendants = document.getElementById("edit_secondNumberOfAttendants").value.trim();
      const newSecondSeatType = document.getElementById("edit_secondSeatType").value.trim();
      const newThirdTrainName = document.getElementById("edit_thirdTrainName").value.trim();
      const newThirdDeparture = document.getElementById("edit_thirdDeparture").value.trim();
      const newThirdArrival = document.getElementById("edit_thirdArrival").value.trim();
      const newThirdNumberOfAdults = document.getElementById("edit_thirdNumberOfAdults").value.trim();
      const newThirdNumberOfChildren = document.getElementById("edit_thirdNumberOfChildren").value.trim();
      const newThirdNumberOfAttendants = document.getElementById("edit_thirdNumberOfAttendants").value.trim();
      const newThirdSeatType = document.getElementById("edit_thirdSeatType").value.trim();

      const updatedData = {
        groupName: newGroupName,
        groupNameFurigana: newGroupNameFurigana,
        groupType: newGroupType,
        departureDate: newDepartureDate,
        arrivalDate: newArrivalDate,
        trainName: newTrainName,
        departure: newDeparture,
        arrival: newArrival,
        numberOfAdults: newNumberOfAdults,
        numberOfChildren: newNumberOfChildren,
        numberOfAttendants: newNumberOfAttendants,
        seatType: newSeatType,
        secondTrainName: newSecondTrainName,
        secondDeparture: newSecondDeparture,
        secondArrival: newSecondArrival,
        secondNumberOfAdults: newSecondNumberOfAdults,
        secondNumberOfChildren: newSecondNumberOfChildren,
        secondNumberOfAttendants: newSecondNumberOfAttendants,
        secondSeatType: newSecondSeatType,
        thirdTrainName: newThirdTrainName,
        thirdDeparture: newThirdDeparture,
        thirdArrival: newThirdArrival,
        thirdNumberOfAdults: newThirdNumberOfAdults,
        thirdNumberOfChildren: newThirdNumberOfChildren,
        thirdNumberOfAttendants: newThirdNumberOfAttendants,
        thirdSeatType: newThirdSeatType,
        last_updated: firebase.firestore.FieldValue.serverTimestamp()
      };

      let changes = [];
      if (newGroupName !== currentData.groupName) changes.push(`団体名: ${newGroupName}`);
      if (newGroupNameFurigana !== currentData.groupNameFurigana) changes.push(`団体名ふりがな: ${newGroupNameFurigana}`);
      if (newGroupType !== currentData.groupType) changes.push(`団体種別: ${newGroupType}`);
      if (newDepartureDate !== currentData.departureDate) changes.push(`出発日: ${newDepartureDate}`);
      if (newArrivalDate !== currentData.arrivalDate) changes.push(`帰着日: ${newArrivalDate}`);
      if (newTrainName !== currentData.trainName) changes.push(`列車名: ${newTrainName}`);
      if (newDeparture !== currentData.departure) changes.push(`発地: ${newDeparture}`);
      if (newArrival !== currentData.arrival) changes.push(`着地: ${newArrival}`);
      if (newNumberOfAdults !== currentData.numberOfAdults) changes.push(`大人: ${newNumberOfAdults}`);
      if (newNumberOfChildren !== currentData.numberOfChildren) changes.push(`小児: ${newNumberOfChildren}`);
      if (newNumberOfAttendants !== currentData.numberOfAttendants) changes.push(`添乗員: ${newNumberOfAttendants}`);
      if (newSeatType !== currentData.seatType) changes.push(`座席: ${newSeatType}`);
      if (newSecondTrainName !== currentData.secondTrainName) changes.push(`第2希望-列車名: ${newSecondTrainName}`);
      if (newSecondDeparture !== currentData.secondDeparture) changes.push(`第2希望-発地: ${newSecondDeparture}`);
      if (newSecondArrival !== currentData.secondArrival) changes.push(`第2希望-着地: ${newSecondArrival}`);
      if (newSecondNumberOfAdults !== currentData.secondNumberOfAdults) changes.push(`第2希望-大人: ${newSecondNumberOfAdults}`);
      if (newSecondNumberOfChildren !== currentData.secondNumberOfChildren) changes.push(`第2希望-小児: ${newSecondNumberOfChildren}`);
      if (newSecondNumberOfAttendants !== currentData.secondNumberOfAttendants) changes.push(`第2希望-添乗員: ${newSecondNumberOfAttendants}`);
      if (newSecondSeatType !== currentData.secondSeatType) changes.push(`第2希望-座席: ${newSecondSeatType}`);
      if (newThirdTrainName !== currentData.thirdTrainName) changes.push(`第3希望-列車名: ${newThirdTrainName}`);
      if (newThirdDeparture !== currentData.thirdDeparture) changes.push(`第3希望-発地: ${newThirdDeparture}`);
      if (newThirdArrival !== currentData.thirdArrival) changes.push(`第3希望-着地: ${newThirdArrival}`);
      if (newThirdNumberOfAdults !== currentData.thirdNumberOfAdults) changes.push(`第3希望-大人: ${newThirdNumberOfAdults}`);
      if (newThirdNumberOfChildren !== currentData.thirdNumberOfChildren) changes.push(`第3希望-小児: ${newThirdNumberOfChildren}`);
      if (newThirdNumberOfAttendants !== currentData.thirdNumberOfAttendants) changes.push(`第3希望-添乗員: ${newThirdNumberOfAttendants}`);
      if (newThirdSeatType !== currentData.thirdSeatType) changes.push(`第3希望-座席: ${newThirdSeatType}`);

      const fileInput = document.getElementById("imageUpload");
      const file = fileInput ? fileInput.files[0] : null;

      if (file) {
        const extension = file.name.split('.').pop();
        const storageRef = storage.ref().child(`cases/${threadId}/caseImage.${extension}`);

        storageRef.put(file)
          .then(snapshot => snapshot.ref.getDownloadURL())
          .then(downloadURL => {
            updatedData.imageUrl = downloadURL;
            changes.push(`画像変更: ${downloadURL}`);
            return updateFirestoreData(updatedData, changes);
          })
          .then(() => {
            alert("案件が更新されました！");
            editing = false;
            loadCaseDetails();
            document.getElementById("spinner").style.display = "none";
          })
          .catch(error => {
            console.error("Error uploading image or updating case:", error);
            alert("画像アップロードまたは更新中にエラーが発生しました。");
            document.getElementById("spinner").style.display = "none";
          });
      } else {
        updateFirestoreData(updatedData, changes)
          .then(() => {
            alert("案件が更新されました！");
            editing = false;
            loadCaseDetails();
          })
          .catch(error => {
            console.error("Error updating case:", error);
            alert("案件更新中にエラーが発生しました。");
          })
          .finally(() => {
            document.getElementById("spinner").style.display = "none";
          });
      }
    }

    function updateFirestoreData(updatedData, changes) {
      return db.collection("companies").doc(companyId).collection("threads").doc(threadId).update(updatedData)
        .then(() => {
          if (changes.length > 0) {
            const editCommentText = "編集内容: " + changes.join(", ");
            const editComment = {
              name: "編集",
              text: editCommentText,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            return db.collection("companies").doc(companyId).collection("threads").doc(threadId)
                     .collection("comments").add(editComment);
          }
        })
        .then(() => {
          console.log("編集コメントを追加しました");
        });
    }

    function loadComments() {
      db.collection("companies").doc(companyId).collection("threads").doc(threadId).collection("comments")
        .orderBy("timestamp", "asc")
        .onSnapshot(snapshot => {
          const commentsList = document.getElementById("commentsList");
          commentsList.innerHTML = "";
          snapshot.forEach(doc => {
            const comment = doc.data();
            const timestamp = comment.timestamp
              ? comment.timestamp.toDate().toLocaleString()
              : "-";
            commentsList.innerHTML += `<p>${comment.name}: ${comment.text} (${timestamp})</p>`;
          });
        });
    }

    // コメント投稿（role情報を反映）
    function submitComment() {
      const newComment = document.getElementById("newComment").value;
      if (!newComment) {
        alert("コメントを入力してください。");
        return;
      }

      let displayName = "販売店担当者";
      if (params.get("role") === "companyA") {
        displayName = "会社A";
      }

      const commentData = {
        name: displayName,
        text: newComment,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      db.collection("companies").doc(companyId).collection("threads").doc(threadId).collection("comments")
        .add(commentData)
        .then(() => {
          document.getElementById("newComment").value = "";
          alert("コメントを投稿しました！");
          sendEmailNotification(newComment);
        })
        .catch(error => {
          console.error("Error posting comment:", error);
        });
    }

    //  function sendEmailNotification(comment) {
    //    emailjs.send("service_yk6nvsg", "template_3xbq589", {
    //      to_email: "yoshiaki.murata20@gmail.com",
     //     message: `新しいコメントが投稿されました: ${comment}`
     //   })
     //   .then(response => console.log("メール通知成功:", response))
     //   .catch(error => console.error("メール送信エラー:", error));
    //  }

    function goToDashboard() {
      window.location.href = "dashboard.html?company=" + companyId;
    }

    loadCaseDetails();
    loadComments();
  </script>
</body>
</html>
