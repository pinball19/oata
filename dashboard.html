<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>販売店ダッシュボード</title>
  <link rel="stylesheet" type="text/css" href="style.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>

  <style>
    /* スピナー本体 */
    #spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none; /* 初期は非表示 */
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .project-card {
      border: 1px solid #ccc;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 5px;
    }
    table {
      border-collapse: collapse;
      margin-top: 0.5em;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.3em;
      text-align: center;
    }
    th {
      background: #f9f9f9;
      min-width: 60px;
    }
    /* 新案件作成フォーム */
    #newCaseForm {
      margin-top: 1em;
      border: 1px solid #ccc;
      padding: 1em;
      border-radius: 5px;
    }
    #newCaseForm table {
      width: auto; 
      margin-bottom: 1em;
    }
    #newCaseForm label {
      display: block;
      margin-bottom: 0.5em;
    }
  </style>

  <script>
    // EmailJS 初期化
    emailjs.init("YOUR_EMAILJS_PUBLIC_KEY");

    // Firebase 初期化
   const firebaseConfig = {
  apiKey: "AIzaSyDPLwpz4GcsNrmn6HNKLPmQWokZgKT4Cis",
  authDomain: "oata-8c05b.firebaseapp.com",
  projectId: "oata-8c05b",
  storageBucket: "oata-8c05b.firebasestorage.app",
  messagingSenderId: "949261471175",
  appId: "1:949261471175:web:28482b939262d8e93f1de2",
  measurementId: "G-02LMR8FTNX"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // URLパラメータ or localStorage から companyId を取得
    const urlParams = new URLSearchParams(window.location.search);
    let companyId = urlParams.get("company") || localStorage.getItem("company_id");
    if (!companyId) {
      alert("ログインしてください");
      window.location.href = "login.html";
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("welcomeMsg").innerText = `ようこそ、${companyId} 様`;
      loadCases();
    });

    // 「新しい案件を作成」フォームを表示
    function showForm() {
      document.getElementById("newCaseForm").style.display = "block";
    }

    // キャンセルボタン
    function cancelNewCase() {
      document.getElementById("newCaseForm").style.display = "none";
      // 入力項目をリセット
      const fields = [
        "groupName","groupNameFurigana","groupType",
        "trainName","departure","arrival","numberOfAdults","numberOfChildren","numberOfAttendants","seatType",
        "secondTrainName","secondDeparture","secondArrival","secondNumberOfAdults","secondNumberOfChildren","secondNumberOfAttendants","secondSeatType",
        "thirdTrainName","thirdDeparture","thirdArrival","thirdNumberOfAdults","thirdNumberOfChildren","thirdNumberOfAttendants","thirdSeatType",
        "caseTitle","departureDate","arrivalDate","contractType","estimatedPrice","confirmedPrice","remarks","caseImage"
      ];
      fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      document.getElementById("spinner").style.display = "none";
    }

    // 新しい案件を作成
    async function createNewCase() {
      const spinner = document.getElementById("spinner");
      spinner.style.display = "block";

      try {
        // 団体情報
        const groupName = document.getElementById("groupName").value.trim();
        const groupNameFurigana = document.getElementById("groupNameFurigana").value.trim();
        const groupType = document.getElementById("groupType").value.trim();

        // 第1希望
        const trainName = document.getElementById("trainName").value.trim();
        const departure = document.getElementById("departure").value.trim();
        const arrival = document.getElementById("arrival").value.trim();
        const numberOfAdults = document.getElementById("numberOfAdults").value.trim();
        const numberOfChildren = document.getElementById("numberOfChildren").value.trim();
        const numberOfAttendants = document.getElementById("numberOfAttendants").value.trim();
        const seatType = document.getElementById("seatType").value.trim();

        // 第2希望
        const secondTrainName = document.getElementById("secondTrainName").value.trim();
        const secondDeparture = document.getElementById("secondDeparture").value.trim();
        const secondArrival = document.getElementById("secondArrival").value.trim();
        const secondNumberOfAdults = document.getElementById("secondNumberOfAdults").value.trim();
        const secondNumberOfChildren = document.getElementById("secondNumberOfChildren").value.trim();
        const secondNumberOfAttendants = document.getElementById("secondNumberOfAttendants").value.trim();
        const secondSeatType = document.getElementById("secondSeatType").value.trim();

        // 第3希望
        const thirdTrainName = document.getElementById("thirdTrainName").value.trim();
        const thirdDeparture = document.getElementById("thirdDeparture").value.trim();
        const thirdArrival = document.getElementById("thirdArrival").value.trim();
        const thirdNumberOfAdults = document.getElementById("thirdNumberOfAdults").value.trim();
        const thirdNumberOfChildren = document.getElementById("thirdNumberOfChildren").value.trim();
        const thirdNumberOfAttendants = document.getElementById("thirdNumberOfAttendants").value.trim();
        const thirdSeatType = document.getElementById("thirdSeatType").value.trim();

        // 基本情報
        const caseTitle = document.getElementById("caseTitle").value.trim();
        const departureDate = document.getElementById("departureDate").value;
        const arrivalDate = document.getElementById("arrivalDate").value;
        const contractType = document.getElementById("contractType").value.trim();
        const estimatedPrice = document.getElementById("estimatedPrice").value.trim();
        const confirmedPrice = document.getElementById("confirmedPrice").value.trim();
        const remarks = document.getElementById("remarks").value.trim();
        const caseImageFile = document.getElementById("caseImage").files[0];

        // 必須チェック
        if (!groupName || !trainName || !departure || !arrival) {
          alert("団体名と第1希望（列車名・発地・着地）は必須項目です。");
          spinner.style.display = "none";
          return;
        }

        let imageUrl = "";
        if (caseImageFile) {
          const ext = caseImageFile.name.split('.').pop();
          const filePath = `threads/${Date.now()}_caseImage.${ext}`;
          const storageRef = storage.ref().child(filePath);
          const snapshot = await storageRef.put(caseImageFile);
          imageUrl = await snapshot.ref.getDownloadURL();
        }

        // Firestore 登録
        await db.collection("companies").doc(companyId).collection("threads").add({
          groupName,
          groupNameFurigana,
          groupType,
          // 第1希望
          trainName,
          departure,
          arrival,
          numberOfAdults,
          numberOfChildren,
          numberOfAttendants,
          seatType,
          // 第2希望
          secondTrainName,
          secondDeparture,
          secondArrival,
          secondNumberOfAdults,
          secondNumberOfChildren,
          secondNumberOfAttendants,
          secondSeatType,
          // 第3希望
          thirdTrainName,
          thirdDeparture,
          thirdArrival,
          thirdNumberOfAdults,
          thirdNumberOfChildren,
          thirdNumberOfAttendants,
          thirdSeatType,
          // 基本情報
          caseTitle,
          departureDate,
          arrivalDate,
          contractType,
          estimatedPrice,
          confirmedPrice,
          remarks,
          imageUrl,
          last_updated: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("案件が作成されました！");
        cancelNewCase();
      } catch (err) {
        console.error("Error creating new case:", err);
        alert("案件作成中にエラーが発生しました。");
      } finally {
        spinner.style.display = "none";
      }
    }

    // 過去半年の案件を表示（カード部分は既存のまま）
    function loadCases() {
      const sixMonthsAgo = new Date();
      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);

      db.collection("companies").doc(companyId).collection("threads")
        .where("last_updated", ">=", sixMonthsAgo)
        .orderBy("last_updated", "desc")
        .onSnapshot(snapshot => {
          const caseListDiv = document.getElementById("caseList");
          caseListDiv.innerHTML = "";
          if (snapshot.empty) {
            caseListDiv.innerHTML = "<p>過去半年の案件はありません</p>";
            return;
          }
          snapshot.forEach(doc => {
            const caseData = doc.data();
            const caseId = doc.id;
            const updatedDate = caseData.last_updated
              ? caseData.last_updated.toDate().toLocaleString()
              : "";

            // カードHTMLは従来のまま
            let div = document.createElement("div");
            div.className = "project-card";

            // 省略：団体名や希望情報のテーブル表示
            // ...
            // ここは「案件カード表示部分」として既存通りに表示してください

            div.innerHTML = `
              <h3>団体名: ${caseData.groupName || caseData.caseTitle || "（未設定）"}</h3>
              <p>更新日時: ${updatedDate}</p>
              <table>
                <thead>
                  <tr>
                    <th></th>
                    <th>列車名</th>
                    <th>発地</th>
                    <th>着地</th>
                    <th>大人</th>
                    <th>小児</th>
                    <th>添乗員</th>
                    <th>座席</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- 第1希望 -->
                  <tr>
                    <th>第1希望</th>
                    <td>${caseData.trainName || "-"}</td>
                    <td>${caseData.departure || "-"}</td>
                    <td>${caseData.arrival || "-"}</td>
                    <td>${caseData.numberOfAdults || "-"}</td>
                    <td>${caseData.numberOfChildren || "-"}</td>
                    <td>${caseData.numberOfAttendants || "-"}</td>
                    <td>${caseData.seatType || "-"}</td>
                  </tr>
                  <!-- 第2希望 -->
                  <tr>
                    <th>第2希望</th>
                    <td>${caseData.secondTrainName || "-"}</td>
                    <td>${caseData.secondDeparture || "-"}</td>
                    <td>${caseData.secondArrival || "-"}</td>
                    <td>${caseData.secondNumberOfAdults || "-"}</td>
                    <td>${caseData.secondNumberOfChildren || "-"}</td>
                    <td>${caseData.secondNumberOfAttendants || "-"}</td>
                    <td>${caseData.secondSeatType || "-"}</td>
                  </tr>
                  <!-- 第3希望 -->
                  <tr>
                    <th>第3希望</th>
                    <td>${caseData.thirdTrainName || "-"}</td>
                    <td>${caseData.thirdDeparture || "-"}</td>
                    <td>${caseData.thirdArrival || "-"}</td>
                    <td>${caseData.thirdNumberOfAdults || "-"}</td>
                    <td>${caseData.thirdNumberOfChildren || "-"}</td>
                    <td>${caseData.thirdNumberOfAttendants || "-"}</td>
                    <td>${caseData.thirdSeatType || "-"}</td>
                  </tr>
                </tbody>
              </table>
              <p><a href="thread.html?company=${companyId}&thread=${caseId}">詳細を見る</a></p>
            `;

            caseListDiv.appendChild(div);
          });
        });
    }

    // CSV ダウンロード（略）
    async function downloadCSV() {
      // ...
    }
  </script>
</body>
</html>
