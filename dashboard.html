<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>販売店ダッシュボード</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- EmailJS -->
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script>
    emailjs.init("YOUR_EMAILJS_PUBLIC_KEY");
    const firebaseConfig = {
      apiKey: "AIzaSyDPLwpz4GcsNrmn6HNKLPmQWokZgKT4Cis",
      authDomain: "oata-8c05b.firebaseapp.com",
      projectId: "oata-8c05b",
      storageBucket: "oata-8c05b.firebasestorage.app",
      messagingSenderId: "949261471175",
      appId: "1:949261471175:web:28482b939262d8e93f1de2",
      measurementId: "G-02LMR8FTNX"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>
  <div class="container">
    <h1>販売店ダッシュボード</h1>
    <p id="welcomeMsg"></p>
    <button onclick="showForm()">＋ 新しい案件を作成</button>
    
    <!-- 新しい案件作成フォーム -->
    <div id="newCaseForm" style="display: none;">
      <h2>案件情報を入力</h2>
      <label>案件名: <input type="text" id="caseTitle"></label><br>
      <label>出発地: <input type="text" id="departure"></label><br>
      <label>帰着地: <input type="text" id="arrival"></label><br>
      <label>マル契種類: <input type="text" id="contractType"></label><br>
      <label>金額（予定）: <input type="number" id="estimatedPrice"></label><br>
      <label>金額（確定）: <input type="number" id="confirmedPrice"></label><br>
      <label>備考: <textarea id="remarks"></textarea></label><br>
      <button onclick="createNewCase()">保存</button>
    </div>

    <h3>過去半年の案件</h3>
    <div id="caseList"></div>
    <button onclick="downloadCSV()">CSV ダウンロード</button>
  </div>

  <script>
    const db = firebase.firestore();
    const urlParams = new URLSearchParams(window.location.search);
    let companyId = urlParams.get("company") || localStorage.getItem("company_id");
    if (!companyId) {
      alert("ログインしてください");
      window.location.href = "login.html";
    }
    document.getElementById("welcomeMsg").innerText = "ようこそ、" + companyId + " 様";

    function showForm() {
      document.getElementById("newCaseForm").style.display = "block";
    }

    function createNewCase() {
      const caseTitle = document.getElementById("caseTitle").value.trim();
      const departure = document.getElementById("departure").value.trim();
      const arrival = document.getElementById("arrival").value.trim();
      const contractType = document.getElementById("contractType").value.trim();
      const estimatedPrice = document.getElementById("estimatedPrice").value.trim();
      const confirmedPrice = document.getElementById("confirmedPrice").value.trim();
      const remarks = document.getElementById("remarks").value.trim();

      if (!caseTitle || !departure || !arrival || !contractType) {
        alert("案件名、出発地、帰着地、マル契種類は必須項目です");
        return;
      }

      db.collection("companies").doc(companyId).collection("threads").add({
        caseTitle: caseTitle,
        departure: departure,
        arrival: arrival,
        contractType: contractType,
        estimatedPrice: estimatedPrice,
        confirmedPrice: confirmedPrice,
        remarks: remarks,
        last_updated: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert("案件が作成されました！");
        document.getElementById("newCaseForm").style.display = "none";
        document.getElementById("caseTitle").value = "";
        document.getElementById("departure").value = "";
        document.getElementById("arrival").value = "";
        document.getElementById("contractType").value = "";
        document.getElementById("estimatedPrice").value = "";
        document.getElementById("confirmedPrice").value = "";
        document.getElementById("remarks").value = "";
      })
      .catch(error => {
        console.error("Error creating new case:", error);
      });
    }

    function loadCases() {
      const sixMonthsAgo = new Date();
      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
      
      db.collection("companies").doc(companyId).collection("threads")
        .where("last_updated", ">=", sixMonthsAgo)
        .orderBy("last_updated", "desc")
        .onSnapshot(snapshot => {
          const caseListDiv = document.getElementById("caseList");
          caseListDiv.innerHTML = "";
          if (snapshot.empty) {
            caseListDiv.innerHTML = "<p>過去半年の案件はありません</p>";
          }
          snapshot.forEach(doc => {
            const caseData = doc.data();
            const caseId = doc.id;
            let updatedDate = caseData.last_updated ? caseData.last_updated.toDate().toLocaleString() : "";
            let div = document.createElement("div");
            div.className = "project-card";
            div.innerHTML = `
              <h3>${caseData.caseTitle} - ${caseData.contractType}</h3>
              <p>出発地: ${caseData.departure}</p>
              <p>帰着地: ${caseData.arrival}</p>
              <p>金額（予定）: ${caseData.estimatedPrice}</p>
              <p>金額（確定）: ${caseData.confirmedPrice}</p>
              <p>備考: ${caseData.remarks}</p>
              <p>更新日時: ${updatedDate}</p>
              <a href="thread.html?company=${companyId}&thread=${caseId}">詳細を見る</a>
            `;
            caseListDiv.appendChild(div);
          });
        });
    }
    loadCases();

    async function downloadCSV() {
      const snapshot = await db.collection("companies").doc(companyId).collection("threads")
        .orderBy("last_updated", "desc")
        .get();

      let csvContent = "data:text/csv;charset=utf-8,案件名,出発地,帰着地,マル契種類,金額（予定）,金額（確定）,備考,作成日\n";
      snapshot.forEach(doc => {
        const caseData = doc.data();
        const createdDate = caseData.last_updated ? caseData.last_updated.toDate().toLocaleString() : "";
        const title = caseData.caseTitle.replace(/"/g, '""');
        const departure = caseData.departure.replace(/"/g, '""');
        const arrival = caseData.arrival.replace(/"/g, '""');
        const contractType = caseData.contractType.replace(/"/g, '""');
        const estimatedPrice = caseData.estimatedPrice;
        const confirmedPrice = caseData.confirmedPrice;
        const remarks = caseData.remarks.replace(/"/g, '""');
        csvContent += `"${title}","${departure}","${arrival}","${contractType}","${estimatedPrice}","${confirmedPrice}","${remarks}","${createdDate}"\n`;
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `案件リスト_${companyId}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
