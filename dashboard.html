<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>販売店ダッシュボード</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- 画像アップロードに必要なFirebase Storage -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <!-- EmailJS -->
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>

  <!-- ★ スピナーの簡易CSSアニメーションを定義 -->
  <style>
    /* スピナー本体 */
    #spinner {
      border: 8px solid #f3f3f3; /* 薄いグレー */
      border-top: 8px solid #3498db; /* 青 */
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* カードの見た目は自由に調整してください */
    .project-card {
      border: 1px solid #ccc;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 5px;
    }
    table {
      border-collapse: collapse;
      margin-top: 0.5em;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.3em;
      text-align: center;
    }
    th {
      background: #f9f9f9;
      min-width: 60px;
    }
    /* 新案件作成フォーム用のテーブル */
    #newCaseForm table {
      width: auto;
      margin-bottom: 1em;
    }
    #newCaseForm label {
      display: block;
      margin-bottom: 0.5em;
    }
  </style>

  <script>
    // EmailJS 初期化（YOUR_EMAILJS_PUBLIC_KEY をご自身のものに置換）
    emailjs.init("YOUR_EMAILJS_PUBLIC_KEY");

    // Firebase 初期化（login.htmlと同じ設定を使用）
const firebaseConfig = {
  apiKey: "AIzaSyDPLwpz4GcsNrmn6HNKLPmQWokZgKT4Cis",
  authDomain: "oata-8c05b.firebaseapp.com",
  projectId: "oata-8c05b",
  storageBucket: "oata-8c05b.firebasestorage.app",
  messagingSenderId: "949261471175",
  appId: "1:949261471175:web:28482b939262d8e93f1de2",
  measurementId: "G-02LMR8FTNX"
};
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>
  <div class="container">
    <h1>販売店ダッシュボード</h1>
    <p id="welcomeMsg"></p>
    <button onclick="showForm()">＋ 新しい案件を作成</button>
    
    <!-- 新しい案件作成フォーム（テーブル形式） -->
    <div id="newCaseForm" style="display: none;">
      <h2>案件情報を入力</h2>
      
      <!-- 団体情報 -->
      <table>
        <tr>
          <th>団体名</th>
          <td><input type="text" id="groupName"></td>
        </tr>
        <tr>
          <th>団体名ふりがな</th>
          <td><input type="text" id="groupNameFurigana"></td>
        </tr>
        <tr>
          <th>団体種別</th>
          <td><input type="text" id="groupType"></td>
        </tr>
      </table>

      <!-- 第1希望 -->
      <h3>第1希望</h3>
      <table>
        <tr>
          <th>列車名</th>
          <td><input type="text" id="trainName"></td>
          <th>発地</th>
          <td><input type="text" id="departure"></td>
          <th>着地</th>
          <td><input type="text" id="arrival"></td>
        </tr>
        <tr>
          <th>大人</th>
          <td><input type="number" id="numberOfAdults"></td>
          <th>小児</th>
          <td><input type="number" id="numberOfChildren"></td>
          <th>添乗員</th>
          <td><input type="number" id="numberOfAttendants"></td>
          <th>座席</th>
          <td><input type="text" id="seatType"></td>
        </tr>
      </table>

      <!-- 第2希望 -->
      <h3>第2希望</h3>
      <table>
        <tr>
          <th>列車名</th>
          <td><input type="text" id="secondTrainName"></td>
          <th>発地</th>
          <td><input type="text" id="secondDeparture"></td>
          <th>着地</th>
          <td><input type="text" id="secondArrival"></td>
        </tr>
        <tr>
          <th>大人</th>
          <td><input type="number" id="secondNumberOfAdults"></td>
          <th>小児</th>
          <td><input type="number" id="secondNumberOfChildren"></td>
          <th>添乗員</th>
          <td><input type="number" id="secondNumberOfAttendants"></td>
          <th>座席</th>
          <td><input type="text" id="secondSeatType"></td>
        </tr>
      </table>

      <!-- 第3希望 -->
      <h3>第3希望</h3>
      <table>
        <tr>
          <th>列車名</th>
          <td><input type="text" id="thirdTrainName"></td>
          <th>発地</th>
          <td><input type="text" id="thirdDeparture"></td>
          <th>着地</th>
          <td><input type="text" id="thirdArrival"></td>
        </tr>
        <tr>
          <th>大人</th>
          <td><input type="number" id="thirdNumberOfAdults"></td>
          <th>小児</th>
          <td><input type="number" id="thirdNumberOfChildren"></td>
          <th>添乗員</th>
          <td><input type="number" id="thirdNumberOfAttendants"></td>
          <th>座席</th>
          <td><input type="text" id="thirdSeatType"></td>
        </tr>
        </table>

      <!-- 第3希望 -->
      <h3>画像添付</h3>
      <table>
        <tr>
          <td colspan="3"><input type="file" id="caseImage" accept="image/*"></td>
        </tr>
      </table>
      <!-- スピナー -->
      <div id="spinner" style="display: none;"></div>
      <button onclick="createNewCase()">保存</button>
      <button onclick="cancelNewCase()">キャンセル</button>
    </div>

    <h3>過去半年の案件</h3>
    <div id="caseList"></div>
    <button onclick="downloadCSV()">CSV ダウンロード</button>
  </div>

  <script>
    const db = firebase.firestore();
    const storage = firebase.storage();
    const urlParams = new URLSearchParams(window.location.search);
    let companyId = urlParams.get("company") || localStorage.getItem("company_id");
    if (!companyId) {
      alert("ログインしてください");
      window.location.href = "login.html";
    }
    document.getElementById("welcomeMsg").innerText = "ようこそ、" + companyId + " 様";

    // フォームを表示
    function showForm() {
      document.getElementById("newCaseForm").style.display = "block";
    }

    // キャンセルボタン：フォームを非表示＆リセット
    function cancelNewCase() {
      document.getElementById("newCaseForm").style.display = "none";
      document.getElementById("groupName").value = "";
      document.getElementById("groupNameFurigana").value = "";
      document.getElementById("groupType").value = "";

      document.getElementById("trainName").value = "";
      document.getElementById("departure").value = "";
      document.getElementById("arrival").value = "";
      document.getElementById("numberOfAdults").value = "";
      document.getElementById("numberOfChildren").value = "";
      document.getElementById("numberOfAttendants").value = "";
      document.getElementById("seatType").value = "";

      document.getElementById("secondTrainName").value = "";
      document.getElementById("secondDeparture").value = "";
      document.getElementById("secondArrival").value = "";
      document.getElementById("secondNumberOfAdults").value = "";
      document.getElementById("secondNumberOfChildren").value = "";
      document.getElementById("secondNumberOfAttendants").value = "";
      document.getElementById("secondSeatType").value = "";

      document.getElementById("thirdTrainName").value = "";
      document.getElementById("thirdDeparture").value = "";
      document.getElementById("thirdArrival").value = "";
      document.getElementById("thirdNumberOfAdults").value = "";
      document.getElementById("thirdNumberOfChildren").value = "";
      document.getElementById("thirdNumberOfAttendants").value = "";
      document.getElementById("thirdSeatType").value = "";

      document.getElementById("caseTitle").value = "";
      document.getElementById("departureDate").value = "";
      document.getElementById("arrivalDate").value = "";
      document.getElementById("contractType").value = "";
      document.getElementById("estimatedPrice").value = "";
      document.getElementById("confirmedPrice").value = "";
      document.getElementById("remarks").value = "";
      document.getElementById("caseImage").value = "";
      document.getElementById("spinner").style.display = "none";
    }

    // 新しい案件作成：画像アップロード + Firestore登録
    async function createNewCase() {
      const spinner = document.getElementById("spinner");
      spinner.style.display = "block";
      try {
        const groupName = document.getElementById("groupName").value.trim();
        const groupNameFurigana = document.getElementById("groupNameFurigana").value.trim();
        const groupType = document.getElementById("groupType").value.trim();

        const trainName = document.getElementById("trainName").value.trim();
        const departure = document.getElementById("departure").value.trim();
        const arrival = document.getElementById("arrival").value.trim();
        const numberOfAdults = document.getElementById("numberOfAdults").value.trim();
        const numberOfChildren = document.getElementById("numberOfChildren").value.trim();
        const numberOfAttendants = document.getElementById("numberOfAttendants").value.trim();
        const seatType = document.getElementById("seatType").value.trim();

        const secondTrainName = document.getElementById("secondTrainName").value.trim();
        const secondDeparture = document.getElementById("secondDeparture").value.trim();
        const secondArrival = document.getElementById("secondArrival").value.trim();
        const secondNumberOfAdults = document.getElementById("secondNumberOfAdults").value.trim();
        const secondNumberOfChildren = document.getElementById("secondNumberOfChildren").value.trim();
        const secondNumberOfAttendants = document.getElementById("secondNumberOfAttendants").value.trim();
        const secondSeatType = document.getElementById("secondSeatType").value.trim();

        const thirdTrainName = document.getElementById("thirdTrainName").value.trim();
        const thirdDeparture = document.getElementById("thirdDeparture").value.trim();
        const thirdArrival = document.getElementById("thirdArrival").value.trim();
        const thirdNumberOfAdults = document.getElementById("thirdNumberOfAdults").value.trim();
        const thirdNumberOfChildren = document.getElementById("thirdNumberOfChildren").value.trim();
        const thirdNumberOfAttendants = document.getElementById("thirdNumberOfAttendants").value.trim();
        const thirdSeatType = document.getElementById("thirdSeatType").value.trim();

        const caseTitle = document.getElementById("caseTitle").value.trim();
        const departureDate = document.getElementById("departureDate").value;
        const arrivalDate = document.getElementById("arrivalDate").value;
        const contractType = document.getElementById("contractType").value.trim();
        const estimatedPrice = document.getElementById("estimatedPrice").value.trim();
        const confirmedPrice = document.getElementById("confirmedPrice").value.trim();
        const remarks = document.getElementById("remarks").value.trim();
        const caseImageFile = document.getElementById("caseImage").files[0];

        if (!groupName || !trainName || !departure || !arrival) {
          alert("団体名と第1希望（列車名・発地・着地）は必須項目です");
          spinner.style.display = "none";
          return;
        }

        let imageUrl = "";
        if (caseImageFile) {
          const extension = caseImageFile.name.split('.').pop();
          const filePath = `threads/${Date.now()}_caseImage.${extension}`;
          const storageRef = storage.ref().child(filePath);
          const snapshot = await storageRef.put(caseImageFile);
          imageUrl = await snapshot.ref.getDownloadURL();
        }

        await db.collection("companies").doc(companyId).collection("threads").add({
          groupName: groupName,
          groupNameFurigana: groupNameFurigana,
          groupType: groupType,
          // 第1希望
          trainName: trainName,
          departure: departure,
          arrival: arrival,
          numberOfAdults: numberOfAdults,
          numberOfChildren: numberOfChildren,
          numberOfAttendants: numberOfAttendants,
          seatType: seatType,
          // 第2希望
          secondTrainName: secondTrainName,
          secondDeparture: secondDeparture,
          secondArrival: secondArrival,
          secondNumberOfAdults: secondNumberOfAdults,
          secondNumberOfChildren: secondNumberOfChildren,
          secondNumberOfAttendants: secondNumberOfAttendants,
          secondSeatType: secondSeatType,
          // 第3希望
          thirdTrainName: thirdTrainName,
          thirdDeparture: thirdDeparture,
          thirdArrival: thirdArrival,
          thirdNumberOfAdults: thirdNumberOfAdults,
          thirdNumberOfChildren: thirdNumberOfChildren,
          thirdNumberOfAttendants: thirdNumberOfAttendants,
          thirdSeatType: thirdSeatType,
          // 基本情報
          caseTitle: caseTitle,
          departureDate: departureDate,
          arrivalDate: arrivalDate,
          contractType: contractType,
          estimatedPrice: estimatedPrice,
          confirmedPrice: confirmedPrice,
          remarks: remarks,
          imageUrl: imageUrl,
          last_updated: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("案件が作成されました！");
        cancelNewCase();
      } catch (error) {
        console.error("Error creating new case:", error);
        alert("案件作成中にエラーが発生しました。");
      } finally {
        spinner.style.display = "none";
      }
    }

    // 過去半年の案件をリアルタイム表示
    function loadCases() {
      const sixMonthsAgo = new Date();
      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
      
      db.collection("companies").doc(companyId).collection("threads")
        .where("last_updated", ">=", sixMonthsAgo)
        .orderBy("last_updated", "desc")
        .onSnapshot(snapshot => {
          const caseListDiv = document.getElementById("caseList");
          caseListDiv.innerHTML = "";
          if (snapshot.empty) {
            caseListDiv.innerHTML = "<p>過去半年の案件はありません</p>";
          }
          snapshot.forEach(doc => {
            const caseData = doc.data();
            const caseId = doc.id;
            let updatedDate = caseData.last_updated
              ? caseData.last_updated.toDate().toLocaleString()
              : "";

            // 各案件をカード表示
            let div = document.createElement("div");
            div.className = "project-card";

            const groupName = caseData.groupName || caseData.caseTitle || "（未設定）";
            const groupNameFurigana = caseData.groupNameFurigana || "";
            const groupType = caseData.groupType || caseData.contractType || "";

            // 第1希望
            const firstTrainName = caseData.trainName || "-";
            const firstDeparture = caseData.departure || "-";
            const firstArrival = caseData.arrival || "-";
            const firstAdults = caseData.numberOfAdults || "-";
            const firstChildren = caseData.numberOfChildren || "-";
            const firstAttendants = caseData.numberOfAttendants || "-";
            const firstSeat = caseData.seatType || "-";

            // 第2希望
            const secondTrainName = caseData.secondTrainName || "-";
            const secondDeparture = caseData.secondDeparture || "-";
            const secondArrival = caseData.secondArrival || "-";
            const secondAdults = caseData.secondNumberOfAdults || "-";
            const secondChildren = caseData.secondNumberOfChildren || "-";
            const secondAttendants = caseData.secondNumberOfAttendants || "-";
            const secondSeat = caseData.secondSeatType || "-";

            // 第3希望
            const thirdTrainName = caseData.thirdTrainName || "-";
            const thirdDeparture = caseData.thirdDeparture || "-";
            const thirdArrival = caseData.thirdArrival || "-";
            const thirdAdults = caseData.thirdNumberOfAdults || "-";
            const thirdChildren = caseData.thirdNumberOfChildren || "-";
            const thirdAttendants = caseData.thirdNumberOfAttendants || "-";
            const thirdSeat = caseData.thirdSeatType || "-";

            div.innerHTML = `
              <h3>団体名: ${groupName}</h3>
              <p>団体名ふりがな: ${groupNameFurigana}</p>
              <p>団体種別: ${groupType}</p>
              <p>更新日時: ${updatedDate}</p>
              <table>
                <thead>
                  <tr>
                    <th></th>
                    <th>列車名</th>
                    <th>発地</th>
                    <th>着地</th>
                    <th>大人</th>
                    <th>小児</th>
                    <th>添乗員</th>
                    <th>座席</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th>第1希望</th>
                    <td>${firstTrainName}</td>
                    <td>${firstDeparture}</td>
                    <td>${firstArrival}</td>
                    <td>${firstAdults}</td>
                    <td>${firstChildren}</td>
                    <td>${firstAttendants}</td>
                    <td>${firstSeat}</td>
                  </tr>
                  <tr>
                    <th>第2希望</th>
                    <td>${secondTrainName}</td>
                    <td>${secondDeparture}</td>
                    <td>${secondArrival}</td>
                    <td>${secondAdults}</td>
                    <td>${secondChildren}</td>
                    <td>${secondAttendants}</td>
                    <td>${secondSeat}</td>
                  </tr>
                  <tr>
                    <th>第3希望</th>
                    <td>${thirdTrainName}</td>
                    <td>${thirdDeparture}</td>
                    <td>${thirdArrival}</td>
                    <td>${thirdAdults}</td>
                    <td>${thirdChildren}</td>
                    <td>${thirdAttendants}</td>
                    <td>${thirdSeat}</td>
                  </tr>
                </tbody>
              </table>
              <p><a href="thread.html?company=${companyId}&thread=${caseId}">詳細を見る</a></p>
            `;
            caseListDiv.appendChild(div);
          });
        });
    }
    loadCases();

    async function downloadCSV() {
      try {
        const snapshot = await db.collection("companies").doc(companyId).collection("threads")
          .orderBy("last_updated", "desc")
          .get();

        let csvContent = "data:text/csv;charset=utf-8,団体名,団体名ふりがな,団体種別,第1希望(列車名),第1希望(発地),第1希望(着地),第2希望(列車名),第2希望(発地),第2希望(着地),第3希望(列車名),第3希望(発地),第3希望(着地),備考,最終更新\n";

        snapshot.forEach(doc => {
          const caseData = doc.data();
          const updatedDate = caseData.last_updated
            ? caseData.last_updated.toDate().toLocaleString()
            : "";

          const groupName = caseData.groupName || "";
          const groupNameFurigana = caseData.groupNameFurigana || "";
          const groupType = caseData.groupType || "";

          const firstTrainName = caseData.trainName || "";
          const firstDeparture = caseData.departure || "";
          const firstArrival = caseData.arrival || "";

          const secondTrainName = caseData.secondTrainName || "";
          const secondDeparture = caseData.secondDeparture || "";
          const secondArrival = caseData.secondArrival || "";

          const thirdTrainName = caseData.thirdTrainName || "";
          const thirdDeparture = caseData.thirdDeparture || "";
          const thirdArrival = caseData.thirdArrival || "";

          const remarks = (caseData.remarks || "").replace(/\"/g, '""');

          csvContent += `"${groupName}","${groupNameFurigana}","${groupType}","${firstTrainName}","${firstDeparture}","${firstArrival}","${secondTrainName}","${secondDeparture}","${secondArrival}","${thirdTrainName}","${thirdDeparture}","${thirdArrival}","${remarks}","${updatedDate}"\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `案件リスト_${companyId}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (error) {
        console.error("Error downloading CSV:", error);
      }
    }
  </script>
</body>
</html>
